# Development docker-compose with Vite hot reload
# Usage: docker compose -f docker-compose.dev.yml up

services:
  postgres:
    image: postgres:15-alpine
    container_name: sentient-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: sentient
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  mqtt:
    image: eclipse-mosquitto:2
    container_name: sentient-mqtt
    ports:
      - "1883:1883"
    command: mosquitto -c /mosquitto-no-auth.conf
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 10s
      timeout: 5s
      retries: 3

  orchestrator:
    build:
      context: .
      dockerfile: ops/docker/Dockerfile.dev
    container_name: sentient-orchestrator
    ports:
      - "8080:8080"
    environment:
      - SENTIENT_CONFIG_DIR=/config
      - SENTIENT_SCENE_GRAPH_PATH=/config/graphs/scene-graph.v1.json
      - MQTT_URL=tcp://mqtt:1883
      - PGHOST=postgres
      - PGUSER=postgres
      - PGPASSWORD=postgres
      - PGDATABASE=sentient
    volumes:
      - ./rooms/_template:/config:ro
    depends_on:
      postgres:
        condition: service_healthy
      mqtt:
        condition: service_started

  ui:
    image: node:20-alpine
    container_name: sentient-ui
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      - VITE_API_HOST=orchestrator
    volumes:
      - ./ui:/app
      - ui-node-modules:/app/node_modules
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    depends_on:
      - orchestrator

volumes:
  postgres-data:
  ui-node-modules:
